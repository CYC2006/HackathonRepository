@page "/"

<h1 style="text-align:center;">ğŸŒ æ°¸çºŒå¤§å¯Œç¿</h1>

<div style="display:flex; justify-content:space-around; margin-bottom:20px;">
    <div>ğŸ’° é‡‘éŒ¢ï¼š@money</div>
    <div>ğŸŒ¿ ç’°ä¿è©•åˆ†ï¼š@ecoScore</div>
    <div>ğŸ›ï¸ ç¤¾æœƒè§€æ„Ÿï¼š@socialScore</div>
    <div>ğŸ“… ç¬¬ @week é€±</div>
</div>

<div class="board">
    @for (int r = 0; r < ROWS; r++)
    {
        for (int c = 0; c < COLS; c++)
        {
            var name = grid[r, c];

            if (name == "ç©ºå¿ƒ")
            {
                <div class="void"></div>
            }
            else if (name == "ç©ºæ ¼")
            {
                <div class="empty-tile"></div>
            }
            else
            {
                var tile = tilesByPos.TryGetValue((r, c), out var t) ? t : null;
                bool isPlayer = tile is not null && tile.Id == playerIndex;

                <div class="tile @(isPlayer ? "player-tile" : "") @(IsCorner(name) ? "corner" : "")"
                     @ondblclick='() => { if (tile != null && tile.Type == "City") ShowCityInfo(tile); }'>
                    @name
                </div>
            }
        }
    }

    <div class="center-dice">
        <button class="btn btn-primary" @onclick="RollDice">ğŸ² æ“²éª°å­</button>
        <div style="margin-top:6px; font-weight:600;">ä½ æ“²åˆ°äº†ï¼š@lastRoll</div>
    </div>
</div>

@if (showDialog)
{
    <div class="overlay">
        <div class="dialog">
            <h3>@dialogTitle</h3>
            <p>@dialogMessage</p>
            <button @onclick="ConfirmEvent">ç¢ºå®š</button>
            <button @onclick="CancelEvent">å–æ¶ˆ</button>
        </div>
    </div>
}

@code {
    const int ROWS = 6, COLS = 10;

    int money = 0, ecoScore = 0, socialScore = 0, week = 1;
    int lastRoll = 0, playerIndex = 0;

    bool showDialog = false;
    string dialogTitle = "", dialogMessage = "";

    // æ’åˆ—ï¼šå¤–æ¡† + ä¸­é–“ç©ºå¿ƒï¼›ã€Œç©ºæ ¼ã€= å¯è¦‹ç™½æ ¼ï¼›ã€Œç©ºå¿ƒã€= ä½”ä½ä½†ä¸å¯è¦‹ï¼ˆä¸è§¸ç™¼ï¼‰
    string[,] grid = new string[ROWS, COLS] {
        { "å°å—","é«˜é›„","å±æ±","äº‹ä»¶","èŠ±è“®","å°æ±","å®œè˜­","äº‹ä»¶","ç¶ å³¶","å°åŒ—" },
        { "å˜‰ç¾©","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","åŸºéš†" },
        { "äº‹ä»¶","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","æ–°åŒ—" },
        { "é›²æ—","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","äº‹ä»¶" },
        { "å½°åŒ–","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","æ¡ƒåœ’" },
        { "å°ä¸­","æ¾æ¹–","äº‹ä»¶","å—æŠ•","è‹—æ —","äº‹ä»¶","åª½ç¥–","äº‹ä»¶","é‡‘é–€","æ–°ç«¹" }
    };

    record Tile(int Id, string Name, string Type, int Row, int Col);
    Dictionary<(int r,int c), Tile> tilesByPos = new();
    List<Tile> ring = new();

    protected override void OnInitialized() => BuildTilesAndRing();

    void BuildTilesAndRing()
    {
        tilesByPos.Clear(); ring.Clear();

        string TypeOf(string n) => n switch {
            "æ©Ÿæœƒ" => "Chance",
            "å‘½é‹" => "Fate",
            "ç©ºæ ¼" => "Empty",
            "ç©ºå¿ƒ" => "Void",
            _      => "City"
        };

        // å»ºç«‹å¯äº’å‹•æ ¼
        for (int r = 0; r < ROWS; r++)
            for (int c = 0; c < COLS; c++)
                if (grid[r,c] is not ("ç©ºå¿ƒ" or "ç©ºæ ¼"))
                    tilesByPos[(r,c)] = new Tile(-1, grid[r,c], TypeOf(grid[r,c]), r, c);

        // ç”Ÿæˆå¤–æ¡†é †æ™‚é‡è·¯å¾‘
        var path = new List<(int r,int c)>();
        for (int c = 0; c < COLS; c++) path.Add((0,c));                    // ä¸Š
        for (int r = 1; r < ROWS; r++) path.Add((r, COLS-1));             // å³
        for (int c = COLS-2; c >= 0; c--) path.Add((ROWS-1,c));           // ä¸‹
        for (int r = ROWS-2; r >= 1; r--) path.Add((r,0));                // å·¦

        int id = 0;
        foreach (var (r,c) in path)
        {
            var n = grid[r,c];
            if (n is "ç©ºæ ¼" or "ç©ºå¿ƒ") continue; // ä¸é€² ring
            var t = tilesByPos[(r,c)];
            var withId = new Tile(id++, t.Name, t.Type, r, c);
            tilesByPos[(r,c)] = withId;
            ring.Add(withId);
        }

        playerIndex = ring.FindIndex(t => t.Name == "å°å—");
        if (playerIndex < 0) playerIndex = 0;
    }

    void RollDice()
    {
        var rand = new Random();
        lastRoll = rand.Next(1, 7);
        playerIndex = (playerIndex + lastRoll) % ring.Count;
        week++;

        var tile = ring[playerIndex];
        if (tile.Type is "City" or "Chance" or "Fate")
        {
            dialogTitle = $"æŠµé”ï¼š{tile.Name}";
            dialogMessage = tile.Type switch {
                "City"   => "æ˜¯å¦æŸ¥çœ‹è©²ç¸£å¸‚è³‡æ–™ï¼Ÿ",
                "Chance" => "æ˜¯å¦åŸ·è¡Œã€æ©Ÿæœƒã€äº‹ä»¶ï¼Ÿ",
                "Fate"   => "æ˜¯å¦åŸ·è¡Œã€å‘½é‹ã€äº‹ä»¶ï¼Ÿ",
                _        => ""
            };
            showDialog = true;
        }
    }

    void ShowCityInfo(Tile tile)
    {
        dialogTitle = $"{tile.Name} è³‡æ–™";
        dialogMessage = $"é€™è£¡å°‡é¡¯ç¤º {tile.Name} çš„æ°¸çºŒç™¼å±•è³‡æ–™ï¼ˆå ä½ï¼‰ã€‚";
        showDialog = true;
    }

    void ConfirmEvent() => showDialog = false;
    void CancelEvent()  => showDialog = false;

    bool IsCorner(string n) => n is "å°å—" or "å°ä¸­" or "å°åŒ—" or "æ¡ƒåœ’";
}