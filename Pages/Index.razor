@page "/"
@using Hackathon.Data
@inject Hackathon.Data.GameState Game

<div class="game-layout">
    <!-- ğŸŸ¦ ä¸­é–“ï¼šåœ°åœ– -->
    <div class="board-container">
        <div class="board">
            <svg class="path-lines" width="100%" height="100%">
                @for (int step = 0; step < lastRoll; step++)
                {
                    int fromIndex = (lastStartIndex + step) % ring.Count;
                    int toIndex = (fromIndex + 1) % ring.Count;

                    var from = GetPos(ring[fromIndex].Name);
                    var to = GetPos(ring[toIndex].Name);

                    <line x1="@from.cx" y1="@from.cy" x2="@to.cx" y2="@to.cy" stroke="#ffc107" stroke-width="3" stroke-linecap="round" />
                }
            </svg>

            @foreach (var t in ring)
            {
                var pos = GetPos(t.Name);
                var isPlayer = (t.Id == Game.PlayerIndex);

                <div class="tile @(isPlayer ? "player-tile" : $"{t.Type.ToLower()}-tile")"
                    style="left:@pos.xpx; top:@pos.ypx;"
                    @ondblclick='() => { if (t.Type == "City") OpenCardPicker(t); }'>
                    <div class="dot"></div>
                    <div class="label">@t.Name</div>
                </div>
            }

            @if (!isRolling && !showCardPicker && !showTransportPicker)
            {
                <div class="dice-container" style="left:@diceX; top:@diceY;">
                    <button class="dice-button" @onclick="RollDice">ğŸ²</button>
                </div>
            }
        </div>
    </div>

    <!-- ğŸŸ¨ å³é‚Šï¼šæ¨™é¡Œèˆ‡æ•¸å€¼ -->
    <div class="right-panel">
        <h2 class="game-title">ğŸŒ æ°¸çºŒå¤§å¯Œç¿ ğŸŒ</h2>
        <div class="stats">
            <div>
                <img src="/images/icons/Dollar.png" class="icon" alt="Money" />
                <span>@Game.Money</span>
            </div>
            <div>
                <img src="/images/icons/EcoScore.png" class="icon" alt="Eco" />
                <span>@Game.EcoScore</span>
            </div>
            <div>
                <img src="/images/icons/SocialScore.png" class="icon" alt="Social" />
                <span>@Game.SocialScore</span>
            </div>
            <div>
                <img src="/images/icons/Week.png" class="icon" alt="Week" />
                <span>@Game.Week</span>
            </div>
        </div>
    </div>
</div>


@if (showCardPicker)
{
    <div class="overlay">
        <div class="dialog">
            <h3 style="margin-bottom:20px;">@currentTileTitle</h3>
            <div class="card-list">
                @foreach (var card in cardDeck)
                {
                    <div class="card-item rarity-bg-@card.Rarity" @onclick="() => PickCard(card)">
                        <div class="card-title">@card.Title</div>
                        <div class="card-meta">
                            <span class="card-city">@card.City</span>
                            <span class="card-rarity rarity-@card.Rarity">@card.Rarity</span>
                        </div>
                        @if (!string.IsNullOrEmpty(card.ImagePath))
                        {
                            <img src="@card.ImagePath" alt="@card.Title" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image"></div>
                        }
                        <div class="card-stats">
                            <span>
                                <img src="/images/icons/Money.png" alt="Money" width="20" height="20" />
                                @card.MoneyChange
                            </span>
                            <span>
                                <img src="/images/icons/EcoScore.png" alt="Eco" width="20" height="20" />
                                @card.EcoChange
                            </span>
                            <span>
                                <img src="/images/icons/SocialScore.png" alt="Social" width="20" height="20" />
                                @card.SocialChange
                            </span>
                        </div>
                        <div class="card-desc">@card.Description</div>
                    </div>
                }
            </div>
            <button class="close-button" @onclick="CloseCardPicker">âœ–</button>
        </div>
    </div>
}


@if (showTransportPicker)
{
    <div class="overlay">
        <div class="dialog">
            <h3>@currentTileTitle</h3>
            <div class="transport-list">
                @foreach (var (city, cost) in transportOptions)
                {
                    <button class="transport-btn" @onclick="() => TravelTo(city, cost)">
                        @city &nbsp; $@cost
                    </button>
                }
            </div>
            <button class="close-button" @onclick="CloseTransportPicker">âœ–</button>
        </div>
    </div>
}


@if (showEventCard)
{
    <div class="overlay">
        <div class="event-card-dialog">
            <h3 class="event-header">ğŸ“¢ ç•¶é€±äº‹ä»¶å¿«å ±</h3>

            @foreach (var card in eventCardDeck)
            {
                <div class="event-card">
                    <div class="event-card-type">ã€@card.Typeã€‘@card.Title</div>

                    @if (!string.IsNullOrEmpty(card.ImagePath))
                    {
                        <img src="@card.ImagePath" alt="@card.Type" class="event-card-image" />
                    }

                    <div class="event-card-stats">
                        <span>
                            <img src="/images/icons/Money.png" width="18" /> @card.MoneyChange
                        </span>
                        <span>
                            <img src="/images/icons/EcoScore.png" width="18" /> @card.EcoChange
                        </span>
                        <span>
                            <img src="/images/icons/SocialScore.png" width="18" /> @card.SocialChange
                        </span>
                    </div>

                    <div class="event-card-desc">@card.Description</div>
                </div>
            }
            <button class="close-button" @onclick="() => showEventCard = false">âœ–</button>
        </div>
    </div>
}

@code {
    const int ROWS = 6, COLS = 10;
    int lastRoll = 0;
    int lastStartIndex = 0;
    string diceX = "0px";
    string diceY = "0px";
    bool isRolling = false;
    bool showCardPicker = false;
    bool showTransportPicker = false;
    bool showEventCard = false;
    string transportType = "";
    string currentTileTitle = "";
    Tile? currentTile;

    List<CardInfo> cardDeck = new();
    List<(string city, int cost)> transportOptions = new();
    List<EventCardInfo> eventCardDeck = new();

    // Transportation Price Table
    static readonly Dictionary<(string type, string to), int> RealFareNTD = new()
    {
        // é«˜éµï¼ˆå—æ¸¯å‡ºç™¼ï¼‰
        { ("é«˜éµ","å°åŒ—"),260 },{ ("é«˜éµ","æ–°åŒ—"),310 },{ ("é«˜éµ","æ¡ƒåœ’"),500 },
        { ("é«˜éµ","æ–°ç«¹"),700 },{ ("é«˜éµ","è‹—æ —"),920 },{ ("é«˜éµ","å°ä¸­"),1330 },
        { ("é«˜éµ","å½°åŒ–"),1510 },{ ("é«˜éµ","é›²æ—"),1510 },{ ("é«˜éµ","å˜‰ç¾©"),1120 },
        { ("é«˜éµ","å°å—"),1390 },{ ("é«˜éµ","é«˜é›„"),1530 },

        // æ©Ÿå ´ï¼ˆæ¡ƒåœ’å‡ºç™¼ï¼‰
        { ("æ©Ÿå ´","å°åŒ—"),1000 },{ ("æ©Ÿå ´","é«˜é›„"),2800 },{ ("æ©Ÿå ´","å°ä¸­"),2200 },
        { ("æ©Ÿå ´","é‡‘é¦¬"),2400 },{ ("æ©Ÿå ´","æ¾æ¹–"),2300 },{ ("æ©Ÿå ´","å°å—"),2500 },
        { ("æ©Ÿå ´","å°æ±"),2700 },{ ("æ©Ÿå ´","èŠ±è“®"),3000 },{ ("æ©Ÿå ´","å˜‰ç¾©"),2200 },

        // å°éµï¼ˆå°ä¸­å‡ºç™¼ï¼‰
        { ("å°éµ","å°åŒ—"),375 },{ ("å°éµ","æ–°åŒ—"),350 },{ ("å°éµ","æ¡ƒåœ’"),340 },
        { ("å°éµ","æ–°ç«¹"),310 },{ ("å°éµ","è‹—æ —"),120 },{ ("å°éµ","å½°åŒ–"),60 },
        { ("å°éµ","é›²æ—"),115 },{ ("å°éµ","å˜‰ç¾©"),180 },{ ("å°éµ","å°å—"),250 },
        { ("å°éµ","é«˜é›„"),380 },{ ("å°éµ","å±æ±"),430 },{ ("å°éµ","å®œè˜­"),420 },
        { ("å°éµ","èŠ±è“®"),750 },{ ("å°éµ","å°æ±"),920 },{ ("å°éµ","åŸºéš†"),410 }
    };

    // Game Blcok Settings
    static string TypeOf(string name) => name.Trim() switch
    {
        "äº‹ä»¶1" or "äº‹ä»¶2" or "äº‹ä»¶3" or "äº‹ä»¶4" or "äº‹ä»¶5" or "äº‹ä»¶6" => "Event",
        "é«˜éµ" or "æ©Ÿå ´" or "å°éµ" => "Transport",
        _ => "City"
    };

    // Game Map Design
    readonly string[] traverseOrder = new[]
    {
        "å°å—","é«˜é›„","å°éµ","å±æ±","å°æ±",
        "äº‹ä»¶1","èŠ±è“®","å®œè˜­","äº‹ä»¶2","æ–°åŒ—",
        "åŸºéš†","é«˜éµ","å°åŒ—","äº‹ä»¶3","æ¡ƒåœ’",
        "æ©Ÿå ´","æ–°ç«¹","äº‹ä»¶4","è‹—æ —","é‡‘é¦¬",
        "å°ä¸­","å—æŠ•","äº‹ä»¶5","å½°åŒ–","é›²æ—",
        "æ¾æ¹–","å˜‰ç¾©","äº‹ä»¶6",
    };

    // Game Block Position and Size Setting
    static readonly Dictionary<string, (int x, int y, int w, int h)> CustomPos = new()
    {
        { "å°å—", (200, 522, 96, 96) },
        { "é«˜é›„", (280, 544, 92, 92) },
        { "å°éµ", (242, 596, 96, 96) },
        { "å±æ±", (262, 650, 88, 88) },
        { "å°æ±", (354, 570, 90, 90) },
        { "äº‹ä»¶1", (370, 504, 84, 84) },
        { "èŠ±è“®", (430, 380, 96, 96) },
        { "å®œè˜­", (480, 196, 90, 90) },
        { "äº‹ä»¶2", (484, 130, 84, 84) },
        { "æ–°åŒ—", (500, 100, 92, 92) },
        { "åŸºéš†", (496, 62, 96, 96) },
        { "é«˜éµ", (460, 58, 96, 96) },
        { "å°åŒ—", (466, 80, 96, 96) },
        { "äº‹ä»¶3", (426, 82, 84, 84) },
        { "æ¡ƒåœ’", (400, 116, 92, 92) },
        { "æ©Ÿå ´", (386, 88, 96, 96) },
        { "æ–°ç«¹", (378, 160, 92, 92) },
        { "äº‹ä»¶4", (350, 174, 84, 84) },
        { "è‹—æ —", (326, 210, 90, 90) },
        { "é‡‘é¦¬", (130, 184, 88, 88) },
        { "å°ä¸­", (294, 280, 96, 96) },
        { "å—æŠ•", (342, 362, 96, 96) },
        { "äº‹ä»¶5", (266, 344, 84, 84) },
        { "å½°åŒ–", (234, 330, 88, 88) },
        { "é›²æ—", (220, 388, 92, 92) },
        { "æ¾æ¹–", (74, 422, 96, 96) },
        { "å˜‰ç¾©", (230, 442, 92, 92) },
        { "äº‹ä»¶6", (198, 468, 92, 92) }
    };

    record Tile(int Id, string Name, string Type);
    List<Tile> ring = new();

    const int BoardW = 980, BoardH = 580;  // .board å…§éƒ¨åƒè€ƒå°ºå¯¸
    const int Cell = 80;                    // é è¨­æ ¼å¤§å°
    const int Gap  = 12;                    // æ ¼èˆ‡æ ¼é–“è·
    const int TopCount = 10;                // ä¸Šåº•é‚Šæ ¼æ•¸
    const int RightCount = 4;               // å³é‚Šæ ¼æ•¸
    const int BottomCount = 9;              // ä¸‹é‚Šï¼ˆé™¤äº†è§’è½å·²å ç”¨ï¼‰
    const int LeftCount = 3;                // å·¦é‚Šæ ¼æ•¸

    protected override void OnInitialized()
    {
        BuildRing();                        // âœ… CHANGED: ä¸å†æƒ 2Dï¼›ç›´æ¥ä¾åºå»ºç«‹ç¯€é»
        if (Game.PlayerIndex < 0 || Game.Week == 1)
            Game.PlayerIndex = ring.FindIndex(t => t.Name == "å°å—"); // èµ·é»ï¼šå°å—

        UpdateDicePosition();
    }

    void BuildRing()
    {
        ring.Clear();
        int id = 0;
        foreach (var name in traverseOrder)
        {
            ring.Add(new Tile(id++, name, TypeOf(name)));
        }
    }

    // âœ… CHANGED: å›å‚³æ¯å€‹åç¨±çš„åº§æ¨™èˆ‡å°ºå¯¸ï¼ˆå„ªå…ˆç”¨ CustomPosï¼Œå¦å‰‡ç®—åœ¨å¤–æ¡†ä¸Šï¼‰
    (string xpx, string ypx, string wpx, string hpx, int cx, int cy) GetPos(string name)
    {
        if (CustomPos.TryGetValue(name, out var p))
        {
            int centerX = p.x + p.w / 2 - 45;
            int centerY = p.y + p.h / 2 - 45;
            return ($"{p.x}px", $"{p.y}px", $"{p.w}px", $"{p.h}px", centerX, centerY);
        }

        // fallback é è¨­
        return ("0px", "0px", "0px", "0px", 0, 0);
    }

    void UpdateDicePosition()
    {
        var tile = ring[Game.PlayerIndex];
        var pos = GetPos(tile.Name);
        diceX = $"{pos.cx + 40}px";   // ç¨å¾®å¾€å·¦ä¸€é»
        diceY = $"{pos.cy - 5}px";
    }

    async void RollDice()
    {
        // avoid double clicking
        if (isRolling) return;
        isRolling = true;

        var rand = new Random();
        lastRoll = rand.Next(1, 7);
        lastStartIndex = Game.PlayerIndex;
        // Game.PlayerIndex = (Game.PlayerIndex + lastRoll) % ring.Count;

        // make sure only one window will show every round
        showCardPicker = false;
        showTransportPicker = false;

        // moving animation
        for (int i = 0; i < lastRoll; i++)
        {
            Game.PlayerIndex = (Game.PlayerIndex + 1) % ring.Count;

            StateHasChanged();
            await Task.Delay(250);
        }

        var tile = ring[Game.PlayerIndex];
        switch (tile.Type)
        {
            case "City": OpenCardPicker(tile); break;
            case "Transport": OpenTransportPicker(tile); break;
            case "Event": OpenEventCardDisplayer(); break;
        }

        isRolling = false;
        UpdateDicePosition();
        StateHasChanged();
    }

    void OpenCardPicker(Tile tile)
    {
        currentTile = tile;
        currentTileTitle = $"{tile.Name}";
        var allCards = CardData.GetCardsForCity(tile.Name);
        foreach (var c in allCards) c.City = tile.Name;
        var rand = new Random();
        cardDeck = allCards.OrderBy(_ => rand.Next()).Take(4).ToList();
        showCardPicker = true;
    }

    void OpenTransportPicker(Tile tile)
    {
        if (tile.Type != "Transport") return; // é˜²æ­¢èª¤è§¸ City æ ¼
        transportType = tile.Name;
        showTransportPicker = true;
        transportOptions.Clear();

        string[] destinations = transportType switch
        {
            "é«˜éµ" => new[] { "å°åŒ—","æ–°åŒ—","æ¡ƒåœ’","æ–°ç«¹","è‹—æ —","å°ä¸­","å½°åŒ–","é›²æ—","å˜‰ç¾©","å°å—","é«˜é›„" },
            "æ©Ÿå ´" => new[] { "å°åŒ—","é«˜é›„","å°ä¸­","é‡‘é¦¬","æ¾æ¹–","å°å—","å°æ±","èŠ±è“®","å˜‰ç¾©" },
            "å°éµ" => new[] { "å°åŒ—","æ–°åŒ—","æ¡ƒåœ’","æ–°ç«¹","è‹—æ —","å½°åŒ–","é›²æ—","å˜‰ç¾©","å°å—","é«˜é›„","èŠ±è“®","å°æ±","å±æ±","å®œè˜­","åŸºéš†" },
            _ => Array.Empty<string>()
        };

        foreach (var dest in destinations)
        {
            if (RealFareNTD.TryGetValue((transportType, dest), out var fare))
                transportOptions.Add((dest, fare)); // é˜²å‘†ï¼Œé¿å… KeyNotFound
        }

        currentTileTitle = $"ğŸš† {transportType} æ­ä¹˜ç›®çš„åœ°";
    }

    void OpenEventCardDisplayer()
    {
        int currentMonth = ((Game.Week - 1) / 4) + 1;

        var allEvents = EventCardData.GetAllEventCards(
            new[] { "å››å­£", "å¤©ç½", "ç¶“æ¿Ÿ", "æ”¿ç­–", "ç’°å¢ƒ", "ç¤¾æœƒ" }[new Random().Next(6)] );

        var validEvents = allEvents
            .Where(e => currentMonth >= e.StartMonth && currentMonth <= e.EndMonth)
            .ToList();

        if (validEvents.Count == 0) return;

        var rand = new Random();
        var card = validEvents[rand.Next(validEvents.Count)];

        eventCardDeck = new List<EventCardInfo> { card };
        showEventCard = true;

        // Apply event effect immediately
        Game.Money += card.MoneyChange;
        Game.EcoScore += card.EcoChange;
        Game.SocialScore += card.SocialChange;
        
        Game.AddEvent(card);

        Game.ApplyWeeklyEffects();
        Game.RecordWeek();
        Game.Week++;
    }

    void PickCard(CardInfo card)
    {
        Game.Money += card.MoneyChange;
        Game.EcoScore += card.EcoChange;
        Game.SocialScore += card.SocialChange;
        showCardPicker = false;
        var newCard = card.Clone();
        if (currentTile != null) newCard.City = currentTile.Name;
        Game.AddCard(newCard);

        // Check for Sustain Card
        var effectData = SustainCardData.GetEffect(card.Title);
        if (effectData != null)
        {
            Game.AddOngoingEffect(
                source: effectData.Til,
                target: effectData.Tar,
                min: effectData.Min,
                max: effectData.Max,
                duration: effectData.Dur
            );
        }

        // next week
        Game.ApplyWeeklyEffects();
        Game.RecordWeek();
        Game.Week++;
    }

    void TravelTo(string city, int cost)
    {
        Game.Money -= cost;
        var dest = ring.FirstOrDefault(t => t.Name == city);
        if (dest != null)
        {
            Game.PlayerIndex = dest.Id;
            showTransportPicker = false;
            OpenCardPicker(dest);
        }
    }

    void CloseCardPicker() => showCardPicker = false;
    void CloseTransportPicker() => showTransportPicker = false;
}