@page "/"
@using Hackathon.Data
@inject Hackathon.Data.GameState Game

<h2 style="text-align:center; font-size:2.2rem; margin-top:20px; margin-bottom:30px;">
    ğŸŒ æ°¸çºŒå¤§å¯Œç¿ ğŸŒ
</h2>

<div style="display:flex; justify-content:space-around; margin-bottom:30px; font-size:1.4rem; font-weight:600;">
    <div>ğŸ’° &nbsp; &nbsp; @Game.Money</div>
    <div>ğŸŒ¿ &nbsp; &nbsp; @Game.EcoScore</div>
    <div>ğŸ›ï¸ &nbsp; &nbsp; @Game.SocialScore</div>
    <div>ğŸ“… &nbsp; &nbsp; @Game.Week</div>
</div>

<div class="board">
    @for (int r = 0; r < ROWS; r++)
    {
        for (int c = 0; c < COLS; c++)
        {
            var name = grid[r, c];

            if (name == "ç©ºå¿ƒ")
            {
                <div class="void"></div>
            }
            else if (name == "ç©ºæ ¼")
            {
                <div class="empty-tile"></div>
            }
            else
            {
                var tile = tilesByPos.TryGetValue((r, c), out var t) ? t : null;
                bool isPlayer = tile is not null && tile.Id == Game.PlayerIndex;

                <div class="tile @(isPlayer ? "player-tile" : "")"
                    @ondblclick='() => { if (tile != null && tile.Type == "City") OpenCardPicker(tile); }'>
                    @name
                </div>
            }
        }
    }

    <div class="center-dice">
        <button class="dice-button" @onclick="RollDice">ğŸ²</button>
        <div class="dice-result">@lastRoll</div>
    </div>
</div>

@if (showCardPicker) // when arrive City
{
    <div class="overlay">
        <div class="dialog">
            <h3 style="margin-bottom:12px;">@currentTileTitle</h3>

            <div class="card-list">
                @foreach (var card in cardDeck)
                {
                    <div class="card-item @card.ColorTag" @onclick="() => PickCard(card)">
                        <div class="card-title">@card.Title</div>
                        <div class="card-meta">
                            <span class="card-city">@card.City</span>
                            <span class="card-rarity rarity-@card.Rarity">@card.Rarity</span>
                        </div>
                        @if (!string.IsNullOrEmpty(card.ImagePath))
                        {
                            <img src="@card.ImagePath" alt="@card.Title" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image"></div>
                        }
                        <div class="card-stats">
                            <div>ğŸ’° @card.MoneyChange ğŸŒ¿ @card.EcoChange ğŸ›ï¸ @card.SocialChange</div>
                        </div>
                        <div class="card-desc">@card.Description</div>
                    </div>
                }
            </div>

            <button class="close-button" @onclick="CloseCardPicker">âœ–</button>
        </div>
    </div>
}

@if (showTransportPicker) // when arrive Transportation
{
    <div class="overlay">
        <div class="dialog">
            <h3>@currentTileTitle</h3>
            <div class="transport-list">
                @foreach (var (city, cost) in transportOptions)
                {
                    <button class="transport-btn" @onclick="() => TravelTo(city, cost)">
                        @city (ğŸ’° @cost)
                    </button>
                }
            </div>
            <button class="close-button" @onclick="CloseTransportPicker">âœ–</button>
        </div>
    </div>
}

@code {

    // ===== å¯¦éš›ç¥¨åƒ¹è¡¨ï¼ˆå–®ä½ï¼šNTDï¼‰ =====
    static readonly Dictionary<(string type, string to), int> RealFareNTD = new()
    {
        // ===== é«˜éµï¼ˆå—æ¸¯å‡ºç™¼ï¼‰ =====
        { ("é«˜éµ", "å°åŒ—"), 260 },
        { ("é«˜éµ", "æ¿æ©‹"), 310 },
        { ("é«˜éµ", "æ¡ƒåœ’"), 500 },
        { ("é«˜éµ", "æ–°ç«¹"), 700 },
        { ("é«˜éµ", "è‹—æ —"), 920 },
        { ("é«˜éµ", "å°ä¸­"), 1330 },
        { ("é«˜éµ", "å½°åŒ–"), 1510 },
        { ("é«˜éµ", "é›²æ—"), 1510 },
        { ("é«˜éµ", "å˜‰ç¾©"), 1120 },
        { ("é«˜éµ", "å°å—"), 1390 },
        { ("é«˜éµ", "é«˜é›„"), 1530 },

        // ===== æ©Ÿå ´ï¼ˆæ¡ƒåœ’å‡ºç™¼ï¼‰ =====
        { ("æ©Ÿå ´", "å°åŒ—"), 1000 },
        { ("æ©Ÿå ´", "é«˜é›„"), 2800 },
        { ("æ©Ÿå ´", "å°ä¸­"), 2200 },
        { ("æ©Ÿå ´", "é‡‘é¦¬"), 2400 },
        { ("æ©Ÿå ´", "æ¾æ¹–"), 2300 },
        { ("æ©Ÿå ´", "å°å—"), 2500 },
        { ("æ©Ÿå ´", "å°æ±"), 2700 },
        { ("æ©Ÿå ´", "èŠ±è“®"), 3000 },
        { ("æ©Ÿå ´", "å˜‰ç¾©"), 2200 },

        // ===== å°éµï¼ˆå°ä¸­å‡ºç™¼ï¼‰ =====
        { ("å°éµ", "å°åŒ—"), 375 },
        { ("å°éµ", "æ–°åŒ—"), 350 },
        { ("å°éµ", "æ¡ƒåœ’"), 340 },
        { ("å°éµ", "æ–°ç«¹"), 310 },
        { ("å°éµ", "è‹—æ —"), 120 },
        { ("å°éµ", "å½°åŒ–"), 60 },
        { ("å°éµ", "é›²æ—"), 115 },
        { ("å°éµ", "å˜‰ç¾©"), 180 },
        { ("å°éµ", "å°å—"), 250 },
        { ("å°éµ", "é«˜é›„"), 380 },
        { ("å°éµ", "å±æ±"), 430 },
        { ("å°éµ", "å®œè˜­"), 420 },
        { ("å°éµ", "èŠ±è“®"), 750 },
        { ("å°éµ", "å°æ±"), 920 },
        { ("å°éµ", "åŸºéš†"), 410 }
    };

    // Basic Variables
    const int ROWS = 6, COLS = 10;
    int money = 1000, ecoScore = 0, socialScore = 0, week = 1;
    int lastRoll = 0;


    bool showCardPicker = false; // 
    bool showTransportPicker = false;
    string transportType = "";
    List<(string city, int cost)> transportOptions = new();
    string currentTileTitle = "";
    Tile? currentTile;

    List<CardInfo> cardDeck = new();

    string[,] grid = new string[ROWS, COLS] {
        { "å°å—","é«˜é›„","å±æ±","äº‹ä»¶","å°æ±","èŠ±è“®","äº‹ä»¶","å®œè˜­","åŸºéš†","é«˜éµ" },
        { "å˜‰ç¾©","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","æ–°åŒ—" },
        { "äº‹ä»¶","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","äº‹ä»¶" },
        { "é›²æ—","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","å°åŒ—" },
        { "å½°åŒ–","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","ç©ºå¿ƒ","æ¡ƒåœ’" },
        { "å°éµ","å°ä¸­","æ¾æ¹–","å—æŠ•","äº‹ä»¶","è‹—æ —","é‡‘é¦¬","äº‹ä»¶","æ–°ç«¹","æ©Ÿå ´" }
    };

    record Tile(int Id, string Name, string Type, int Row, int Col);
    Dictionary<(int r, int c), Tile> tilesByPos = new();
    List<Tile> ring = new();

    protected override void OnInitialized() => BuildTilesAndRing();

    void BuildTilesAndRing()
    {
        tilesByPos.Clear(); ring.Clear();

        string TypeOf(string n) => n switch
        {
            "äº‹ä»¶" => "Event",
            "ç©ºå¿ƒ" => "Void",
            "é«˜éµ" or "æ©Ÿå ´" or "å°éµ" => "Transport",
            _ => "City"
        };

        for (int r = 0; r < ROWS; r++)
            for (int c = 0; c < COLS; c++)
                if (grid[r, c] is not ("ç©ºå¿ƒ" or "ç©ºæ ¼"))
                    tilesByPos[(r, c)] = new Tile(-1, grid[r, c], TypeOf(grid[r, c]), r, c);

        var path = new List<(int r, int c)>();
        for (int c = 0; c < COLS; c++) path.Add((0, c));
        for (int r = 1; r < ROWS; r++) path.Add((r, COLS - 1));
        for (int c = COLS - 2; c >= 0; c--) path.Add((ROWS - 1, c));
        for (int r = ROWS - 2; r >= 1; r--) path.Add((r, 0));

        int id = 0;
        foreach (var (r, c) in path)
        {
            var n = grid[r, c];
            if (n is "ç©ºæ ¼" or "ç©ºå¿ƒ") continue;
            var t = tilesByPos[(r, c)];
            var withId = new Tile(id++, t.Name, t.Type, r, c);
            tilesByPos[(r, c)] = withId;
            ring.Add(withId);
        }

        if (Game.PlayerIndex == 0 && Game.Week == 1)
        {
            Game.PlayerIndex = ring.FindIndex(t => t.Name == "å°å—");
        }
    }

    void RollDice()
    {
        var rand = new Random();
        lastRoll = rand.Next(1, 7);
        Game.PlayerIndex = (Game.PlayerIndex + lastRoll) % ring.Count;
        Game.Week++;

        var tile = ring[Game.PlayerIndex];
        if (tile.Type is "City" or "Event")
        {
            OpenCardPicker(tile);
        }
        else if (tile.Type == "Transport")
        {
            OpenTransportPicker(tile);
        }
    }

    void OpenCardPicker(Tile tile)
    {
        currentTile = tile;
        currentTileTitle = $"æŠµé”ï¼š{tile.Name}";
        // ç›´æ¥å¾ CardData å–å¾—å®Œæ•´10å¼µå¡ç‰‡è³‡æ–™
        var allCards = CardData.GetCardsForCity(tile.Name);
        
        foreach (var c in allCards) c.City = tile.Name;

        //  pick random 4 cards
        var rand = new Random();
        cardDeck = allCards.OrderBy(_ => rand.Next()).Take(4).ToList();
        
        showCardPicker = true;
    }

    void OpenTransportPicker(Tile tile)
    {
        transportType = tile.Name;
        showTransportPicker = true;
        transportOptions.Clear();

        var rand = new Random();

        string[] destinations = transportType switch
        {
            "é«˜éµ" => new[] { "å°åŒ—","æ–°åŒ—","æ¡ƒåœ’","æ–°ç«¹","è‹—æ —","å°ä¸­","å½°åŒ–","é›²æ—","å˜‰ç¾©","å°å—","é«˜é›„" },
            "æ©Ÿå ´" => new[] { "æ¡ƒåœ’","å°åŒ—","é«˜é›„","å°ä¸­","é‡‘é¦¬","æ¾æ¹–","å°å—","å°æ±","èŠ±è“®","å˜‰ç¾©" },
            "å°éµ" => new[] { "å°åŒ—","æ–°åŒ—","æ¡ƒåœ’","æ–°ç«¹","è‹—æ —","å°ä¸­","å½°åŒ–","é›²æ—","å˜‰ç¾©","å°å—","é«˜é›„","èŠ±è“®","å°æ±","å®œè˜­","åŸºéš†" },
            _ => Array.Empty<string>()
        };

        int baseMax = transportType switch
        {
            "é«˜éµ" => 1530,
            "æ©Ÿå ´" => 3000,
            "å°éµ" => 920,
            _ => 1500
        };

        foreach (var dest in destinations)
        {
            int ntd;
            if (RealFareNTD.TryGetValue((transportType, dest), out var fare))
            {
                ntd = fare;
            }
            else
            {
                // è‹¥æŸ¥ä¸åˆ° â†’ çŒœæ¸¬è·é›¢ï¼ˆæ¨¡æ“¬ï¼Œä¾åºå¢åŠ ï¼‰
                ntd = 500 + Array.IndexOf(destinations, dest) * 150;
            }

            // æ›ç®—æˆéŠæˆ²å…§è²»ç”¨ï¼ˆ1~500ï¼‰
            int gameCost = (int)Math.Round(Math.Clamp(ntd * 500.0 / baseMax, 5, 500) / 5.0) * 5;
            transportOptions.Add((dest, gameCost));

        }

        currentTileTitle = $"ğŸš† {transportType} æ­ä¹˜ç›®çš„åœ°";
    }

    void PickCard(CardInfo card)
    {
        Game.Money += card.MoneyChange;
        Game.EcoScore += card.EcoChange;
        Game.SocialScore += card.SocialChange;

        showCardPicker = false;

        /* Record City */
        var newCard = card.Clone();
        if (currentTile != null)
            newCard.City = currentTile.Name; // è¨˜éŒ„æ˜¯å“ªå€‹åŸå¸‚æŠ½åˆ°çš„
        Game.AddCard(card.Clone());
    }

    void TravelTo(string city, int cost)
    {
        Game.Money -= cost;

        var destination = ring.FirstOrDefault(t => t.Name == city);
        if (destination != null)
        {
            Game.PlayerIndex = destination.Id;
            showTransportPicker = false;
            OpenCardPicker(destination); // æŠµé”å¾Œé–‹å•Ÿè©²åœ°å¡ç‰‡
        }
    }

    void CloseCardPicker() => showCardPicker = false;

    void CloseTransportPicker() => showTransportPicker = false;
}