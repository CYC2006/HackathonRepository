@page "/analytics"
@using Hackathon.Data
@inject GameState Game

<h2 style="text-align:center; margin:20px 0;">ğŸ“Š Game Progress</h2>

@if (Game.History.Count > 0)
{
    <div class="chart-wrap">
        <svg width="1000" height="600" style="background:#e5e5e5; border-radius:12px;">
            @{
                // === åŸºæœ¬ç•«å¸ƒè¨­å®š ===
                const double chartTop = 80;
                const double chartBottom = 530;
                const double xStart = 80;
                const double xStep = 20;
                const double leftAxisX = 60;
                const double rightAxisX = 950;
                const int gridCount = 8;     // å…«æ¢ç·š
                const int baseLineIndex = 2; // ç¬¬ä¸‰æ¢ç‚ºæº–ç·š
                const double spacing = (chartBottom - chartTop) / (gridCount - 1);

                // === è®€å–è³‡æ–™ ===
                double minMoney = Game.History.Min(h => h.Money);
                double maxMoney = Game.History.Max(h => h.Money);
                double minEco = Game.History.Min(h => h.EcoScore);
                double maxEco = Game.History.Max(h => h.EcoScore);
                double minSoc = Game.History.Min(h => h.SocialScore);
                double maxSoc = Game.History.Max(h => h.SocialScore);

                // === Eco/Social å…±ç”¨ ===
                double minRightRaw = Math.Min(minEco, minSoc);
                double maxRightRaw = Math.Max(maxEco, maxSoc);

                // === Money è»¸å‹•æ…‹ç¯„åœ ===
                // ï¼Šæ”¹å‹•é»ï¼šç”¨ stepM æ§åˆ¶ï¼›ä¸Šç•Œ=5*stepMï¼Œä¸‹ç•Œ=-2*stepMã€‚
                //   åˆå§‹ stepM=1000ï¼ˆå°æ‡‰ -2000~5000ï¼‰ï¼›å¦‚è¶…ç•Œï¼Œæ¯æ¬¡ +100ï¼ˆâ†’ ä¸Šç•Œ+500ã€ä¸‹ç•Œ-200ï¼‰ã€‚
                int stepM = 1000;
                while (5 * stepM < maxMoney) stepM += 100;   // æ“´ä¸Šç•Œ
                while (-2 * stepM > minMoney) stepM += 100;  // æ“´ä¸‹ç•Œ
                double moneyMin = -2 * stepM;
                double moneyMax =  5 * stepM;

                // === Eco/Social è»¸å‹•æ…‹ç¯„åœ ===
                // ï¼Šæ”¹å‹•é»ï¼šç”¨ stepR æ§åˆ¶ï¼›ä¸Šç•Œ=5*stepRï¼Œä¸‹ç•Œ=-2*stepRã€‚
                //   åˆå§‹ stepR=20ï¼ˆå°æ‡‰ -40~100ï¼‰ï¼›å¦‚è¶…ç•Œï¼Œæ¯æ¬¡ +10ï¼ˆâ†’ ä¸Šç•Œ+50ã€ä¸‹ç•Œ-20ï¼‰ã€‚
                int stepR = 20;
                while (5 * stepR < maxRightRaw) stepR += 10;   // æ“´ä¸Šç•Œ
                while (-2 * stepR > minRightRaw) stepR += 10;  // æ“´ä¸‹ç•Œ
                double rightMin = -2 * stepR;
                double rightMax =  5 * stepR;

                // === åº§æ¨™è½‰æ› ===
                double ToY(double val, double minVal, double maxVal)
                    => chartBottom - (val - minVal) / (maxVal - minVal) * (chartBottom - chartTop);

                double MoneyToY(double v) => ToY(v, moneyMin, moneyMax);
                double RightToY(double v) => ToY(v, rightMin, rightMax);

                // === æ©«ç·šé–“è· ===
                // ï¼Šæ”¹å‹•é»ï¼šåˆ»åº¦é–“è·æ”¹ç”± stepM/stepR æ§åˆ¶ï¼Œä½†æ©«ç·šä»ç‚ºå›ºå®šå…«ç­‰åˆ†ï¼ˆä¸ä¾æ¯”ä¾‹ï¼‰ã€‚
                double stepMoney = (moneyMax - moneyMin) / (gridCount - 1);
                double stepRight = (rightMax - rightMin) / (gridCount - 1);
            }

            <!-- x axes -->
            @for (int i = 0; i < gridCount; i++)
            {
                double y = chartBottom - i * spacing;
                string style = i == baseLineIndex ? "stroke:#000;stroke-width:2;" : "stroke:#ccc;stroke-dasharray:3,3;";
                <line x1="@leftAxisX" y1="@y" x2="@rightAxisX" y2="@y" style="@style" />
            }

            <!-- y axes -->
            <line x1="@leftAxisX" y1="@chartTop" x2="@leftAxisX" y2="@chartBottom" stroke="#000" stroke-width="2" />
            <line x1="@rightAxisX" y1="@chartTop" x2="@rightAxisX" y2="@chartBottom" stroke="#000" stroke-width="2" />

            <!-- === Left axes: Money === -->
            @for (int i = 0; i < gridCount; i++)
            {
                double v = moneyMin + i * stepMoney;
                double y = MoneyToY(v);
                <g>
                    <text x="@(leftAxisX - 8)" y="@(y + 4)" text-anchor="end" font-size="12">@Math.Round(v)</text>
                </g>
            }
            <image href="/images/icons/Money.png" x="45" y="@(chartTop - 35)" width="30" height="30" />

            <!-- === Right axes: Eco/Social === -->
            @for (int i = 0; i < gridCount; i++)
            {
                double v = rightMin + i * stepRight;
                double y = RightToY(v);
                <g>
                    <text x="@(rightAxisX + 12)" y="@(y + 4)" font-size="12" text-anchor="start">@Math.Round(v)</text>
                </g>
            }
            <image href="/images/icons/EcoScore.png" x="935" y="@(chartTop - 65)" width="28" height="28" />
            <image href="/images/icons/SocialScore.png" x="935" y="@(chartTop - 35)" width="28" height="28" />

            <!-- === æŠ˜ç·šç¹ªè£½ === -->
            @{
                var moneyPts = Game.History.Select((h, i) => $"{xStart + i * xStep},{MoneyToY(h.Money)}");
                var ecoPts   = Game.History.Select((h, i) => $"{xStart + i * xStep},{RightToY(h.EcoScore)}");
                var socPts   = Game.History.Select((h, i) => $"{xStart + i * xStep},{RightToY(h.SocialScore)}");
            }

            <polyline points="@string.Join(" ", moneyPts)" fill="none" stroke="#FFD700" stroke-width="3" />
            <polyline points="@string.Join(" ", ecoPts)" fill="none" stroke="#00C853" stroke-width="3" />
            <polyline points="@string.Join(" ", socPts)" fill="none" stroke="#2979FF" stroke-width="3" />

            <!-- === è³‡æ–™é» === -->
            @for (int i = 0; i < Game.History.Count; i++)
            {
                double x = xStart + i * xStep;
                double yM = MoneyToY(Game.History[i].Money);
                double yE = RightToY(Game.History[i].EcoScore);
                double yS = RightToY(Game.History[i].SocialScore);

                <g class="data-point">
                    <circle cx="@x" cy="@yM" r="6" fill="#E6B800" />
                    <text x="@x" y="@(yM - 12)" class="data-label">@Game.History[i].Money</text>
                </g>
                <g class="data-point">
                    <circle cx="@x" cy="@yE" r="6" fill="#009624" />
                    <text x="@x" y="@(yE - 12)" class="data-label">@Game.History[i].EcoScore</text>
                </g>
                <g class="data-point">
                    <circle cx="@x" cy="@yS" r="6" fill="#0D47A1" />
                    <text x="@x" y="@(yS - 12)" class="data-label">@Game.History[i].SocialScore</text>
                </g>
            }

            <!-- === åœ–ä¾‹ (Legend) === -->
            <g transform="translate(600,570)">
                <circle cx="0" cy="0" r="8" fill="#FFD700" />
                <text x="10" y="5" font-size="16">Money</text>

                <circle cx="120" cy="0" r="8" fill="#00C853" />
                <text x="130" y="5" font-size="16">EcoScore</text>

                <circle cx="240" cy="0" r="8" fill="#2979FF" />
                <text x="250" y="5" font-size="16">SocialScore</text>
            </g>
        </svg>
    </div>
}

<!-- === è³‡æ–™è¡¨ === -->
<div class="table-container">
    @if (Game.History.Count == 0)
    {
        <p>No record yet.</p>
    }
    else
    {
        <table class="record-table">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Money ğŸ’°</th>
                    <th>Eco ğŸŒ¿</th>
                    <th>Social ğŸ¤</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Game.History.Count; i++)
                {
                    var rec = Game.History[i];
                    <tr>
                        <td>@i</td>
                        <td>@rec.Money</td>
                        <td>@rec.EcoScore</td>
                        <td>@rec.SocialScore</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>